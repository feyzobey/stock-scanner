<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stok Barkod Okuyucu</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 12px;
      max-width: 640px;
      margin: 0 auto;
    }

    video {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
    }

    button {
      cursor: pointer;
      border: 0;
      border-radius: 8px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .row {
      margin-top: 8px;
    }

    .ok {
      color: #0a7a2d;
    }

    .err {
      color: #b00020;
    }

    .muted {
      color: #666;
      font-size: 13px;
    }

    .card {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
    }

    .k {
      font-weight: 700;
    }

    .small {
      font-size: 14px;
    }
  </style>
</head>

<body>

  <h2>üì¶ Stok Giri≈ü / √áƒ±kƒ±≈ü</h2>

  <video id="video" playsinline></video>

  <div class="card">
    <div class="row small"><span class="k">Barkod:</span></div>
    <input id="barcode" placeholder="Barkod (EAN-13)" readonly />

    <div id="productInfo" class="muted">√úr√ºn: <b>-</b></div>
    <div id="productHint" class="muted"></div>
  </div>

  <div class="card">
    <select id="action">
      <option value="IN">IN (Giri≈ü)</option>
      <option value="OUT">OUT (√áƒ±kƒ±≈ü)</option>
    </select>

    <select id="movementType">
      <option value="Purchase">Purchase</option>
      <option value="Sale">Sale</option>
      <option value="Shipment">Shipment</option>
      <option value="Return">Return</option>
      <option value="Adjustment">Adjustment</option>
    </select>

    <input id="qty" type="number" value="1" min="1" />

    <select id="locationSelect">
      <option value="">Lokasyon y√ºkleniyor...</option>
    </select>

    <input id="refNo" placeholder="Referans No (sipari≈ü/irsaliye) - opsiyonel" />
    <input id="channel" placeholder="Kanal (Amazon/Woo/Manuel) - opsiyonel" />

    <button id="saveBtn" onclick="send()" disabled>Kaydet</button>

    <p id="result"></p>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzbglq8iu9FvhzROtOpkTrkg0Lm9OLE0kmnLaDfhQ1ocpdBcjYfahIch46ttoT1KSbFwg/exec";
    const API_TOKEN = "Ahmet-2025-Stock-Token-9f3b7c1a";


    const els = {
      video: document.getElementById("video"),
      barcode: document.getElementById("barcode"),
      productInfo: document.getElementById("productInfo"),
      productHint: document.getElementById("productHint"),
      action: document.getElementById("action"),
      movementType: document.getElementById("movementType"),
      qty: document.getElementById("qty"),
      locationSelect: document.getElementById("locationSelect"),
      refNo: document.getElementById("refNo"),
      channel: document.getElementById("channel"),
      saveBtn: document.getElementById("saveBtn"),
      result: document.getElementById("result"),
    };

    let lastBarcode = "";
    let productOk = false;

    function setResult(html) { els.result.innerHTML = html || ""; }

    function normLoc(v) { return (v || "").trim().toUpperCase(); }

    async function apiGet(mode, params = {}) {
      const u = new URL(API_URL);
      u.searchParams.set("mode", mode);
      u.searchParams.set("token", API_TOKEN);
      Object.entries(params).forEach(([k, v]) => u.searchParams.set(k, v));
      const res = await fetch(u.toString());
      return await res.json();
    }

    async function loadLocations() {
      try {
        const json = await apiGet("locations");
        if (!json.ok) throw new Error(json.error || "locations error");

        const locs = (json.locations || []).map(normLoc).filter(Boolean);
        els.locationSelect.innerHTML = "";

        if (locs.length === 0) {
          els.locationSelect.innerHTML = `<option value="">Lokasyon yok (Locations sayfasƒ±nƒ± doldur)</option>`;
          return;
        }

        els.locationSelect.innerHTML = `<option value="">Lokasyon se√ß</option>` +
          locs.map(l => `<option value="${l}">${l}</option>`).join("");
      } catch (e) {
        els.locationSelect.innerHTML = `<option value="">Lokasyon y√ºklenemedi</option>`;
      }
    }

    function updateSaveButtonState() {
      const hasBarcode = !!els.barcode.value;
      const hasLoc = !!els.locationSelect.value;
      const qtyOk = Number(els.qty.value) > 0;
      els.saveBtn.disabled = !(hasBarcode && hasLoc && qtyOk && productOk);
    }

    async function fetchProduct(barcode) {
      productOk = false;
      updateSaveButtonState();

      els.productInfo.innerHTML = `√úr√ºn: <b>Kontrol ediliyor...</b>`;
      els.productHint.textContent = "";

      try {
        const json = await apiGet("product", { barcode });
        if (json.ok && json.product) {
          const p = json.product;
          productOk = true;
          els.productInfo.innerHTML = `√úr√ºn: <b>${escapeHtml(p.name || "-")}</b> <span class="muted">(${escapeHtml(p.sku || "")})</span>`;
          // default location √∂nerisi (bo≈üsa se√ß)
          const defLoc = normLoc(p.defaultLocation || "");
          if (!els.locationSelect.value && defLoc) {
            const opt = Array.from(els.locationSelect.options).find(o => o.value === defLoc);
            if (opt) els.locationSelect.value = defLoc;
          }
        } else {
          productOk = false;
          els.productInfo.innerHTML = `√úr√ºn: <b class="err">Tanƒ±mlƒ± deƒüil</b>`;
          els.productHint.innerHTML = `<span class="err">Bu barkod Products sayfasƒ±nda yok. √ñnce √ºr√ºn√º ekleyin.</span>`;
        }
      } catch (e) {
        productOk = false;
        els.productInfo.innerHTML = `√úr√ºn: <b class="err">Kontrol edilemedi</b>`;
        els.productHint.innerHTML = `<span class="err">API eri≈üimi ba≈üarƒ±sƒ±z.</span>`;
      }

      updateSaveButtonState();
    }

    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    // Barcode scanner
    const codeReader = new ZXing.BrowserBarcodeReader();

    codeReader.decodeFromVideoDevice(null, els.video, (result, err) => {
      if (result) {
        const bc = String(result.text || "").trim();
        if (!bc || bc === lastBarcode) return; // aynƒ± barkodu spamlamasƒ±n
        lastBarcode = bc;

        els.barcode.value = bc;
        navigator.vibrate?.(100);

        setResult("");
        fetchProduct(bc);
        updateSaveButtonState();
      }
    });

    // UI change listeners
    els.locationSelect.addEventListener("change", updateSaveButtonState);
    els.qty.addEventListener("input", updateSaveButtonState);

    async function send() {
      updateSaveButtonState();
      if (els.saveBtn.disabled) return;

      els.saveBtn.disabled = true;
      setResult("<span class='muted'>Kaydediliyor...</span>");

      const payload = {
        action: els.action.value,
        movementType: els.movementType.value,
        barcode: els.barcode.value.trim(),
        qty: Number(els.qty.value),
        location: normLoc(els.locationSelect.value),
        refNo: els.refNo.value.trim(),
        channel: els.channel.value.trim(),
        note: "",
        token: API_TOKEN
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload) // header yok => CORS preflight yok
        });

        let json = null;
        try { json = await res.json(); } catch (_) { }

        if (json && json.ok) {
          setResult("<span class='ok'>‚úî Kaydedildi</span>");
          // hƒ±zlƒ± kullanƒ±m: qty tekrar 1 olsun
          els.qty.value = 1;
        } else if (json && json.error === "Insufficient stock") {
          const d = json.details || {};
          setResult(`<span class='err'>‚ùå Yetersiz stok! Mevcut: ${d.available} | ƒ∞stenen: ${d.requested} | Lokasyon: ${escapeHtml(d.location)}</span>`);
        } else if (json && json.error === "ProductNotFound") {
          setResult("<span class='err'>‚ùå √úr√ºn tanƒ±mlƒ± deƒüil (Products)</span>");
          productOk = false;
        } else if (json && json.error) {
          setResult(`<span class='err'>‚ùå Hata: ${escapeHtml(json.error)}</span>`);
        } else {
          setResult("<span class='err'>‚ùå Kaydedilemedi</span>");
        }
      } catch (e) {
        setResult("<span class='err'>‚ùå Baƒülantƒ± hatasƒ±</span>");
      } finally {
        updateSaveButtonState();
      }
    }

    // Init
    loadLocations().then(updateSaveButtonState);
  </script>

</body>

</html>
